@page "/movies/create"
@attribute [Authorize(Roles = "Administrator")]
@inject IMovieService MovieService
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>Add Movie - FB App</PageTitle>

<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => Navigation.NavigateTo("/movies"))">
            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowLeft())" Slot="start" />
            Back to Movies
        </FluentButton>
    </div>

    <FluentCard Class="p-8">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-neutral-800 dark:text-neutral-100">Add New Movie</h1>
            <p class="text-neutral-600 dark:text-neutral-400 mt-1">Fill in the details to add a new movie</p>
        </div>

        <EditForm Model="@_model" OnValidSubmit="HandleSubmitAsync" FormName="CreateMovieForm">
            <DataAnnotationsValidator />

            <div class="space-y-5">
                <div>
                    <FluentTextField 
                        @bind-Value="_model.Title"
				        Immediate="true"
                        Label="Title" 
                        Placeholder="Enter movie title"
                        Style="width: 100%;"
                        Required="true" />
                    <ValidationMessage For="@(() => _model.Title)" class="text-red-500 text-sm mt-1" />
                </div>

                <div>
                    <FluentTextArea 
                        @bind-Value="_model.Description"
                        Immediate="true"
                        Label="Description" 
                        Placeholder="Enter movie description"
                        Rows="4"
                        Style="width: 100%;" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <FluentTextField 
                            @bind-Value="_model.Director"
                            Immediate="true"
                            Label="Director" 
                            Placeholder="Director name"
                            Style="width: 100%;" />
                    </div>
                    <div>
                        <FluentTextField 
                            @bind-Value="_model.Genre"
                            Immediate="true"
                            Label="Genre" 
                            Placeholder="e.g., Action, Drama"
                            Style="width: 100%;" />
                    </div>
                </div>

                <div>
                    <FluentTextField 
                        @bind-Value="_model.ReleaseYear"
                        Immediate="true"
                        Label="Release Year"
                        TextFieldType="TextFieldType.Number"
                        Placeholder="e.g., 2024"
                        Style="width: 100%;" />
                </div>

                <div>
                    <FluentNumberField
                        @bind-Value="_model.Rating"
                        Immediate="true"
                        Label="Rating"
                        TValue="double?"
                        Placeholder="e.g., 8.5"
						Style="width: 100%;" />
                </div>
                

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <FluentMessageBar Intent="MessageIntent.Error">
                        @_errorMessage
                    </FluentMessageBar>
                }

                <div class="flex gap-4 pt-4">
                    <FluentButton 
                        Type="ButtonType.Submit" 
                        Appearance="Appearance.Accent" 
                        Loading="@_isLoading">
                        <FluentIcon Value="@(new Icons.Regular.Size20.Save())" Slot="start" />
                        Save Movie
                    </FluentButton>
                    <FluentButton 
                        Appearance="Appearance.Outline" 
                        OnClick="@(() => Navigation.NavigateTo("/movies"))">
                        Cancel
                    </FluentButton>
                </div>
            </div>
        </EditForm>
    </FluentCard>
</div>

@code {
    private readonly CreateMovieViewModel _model = new();
    private bool _isLoading;
    private string? _errorMessage;

	private async Task HandleSubmitAsync()
	{
		_isLoading = true;
		_errorMessage = null;

		try
		{
			var releaseYear = int.TryParse(_model.ReleaseYear, out var year) ? year : (int?)null;
			var result = await MovieService.CreateMovieAsync(
				_model.Title,
				_model.Description,
				_model.Director,
				_model.Genre,
				releaseYear,
				_model.Rating);

			if (result.IsSuccess)
			{
				ToastService.ShowSuccess("Movie created successfully!");
				Navigation.NavigateTo($"/movies/{result.Value}");
			}
			else
			{
				_errorMessage = string.Join(", ", result.Errors);
			}
		}
		finally
		{
			_isLoading = false;
			StateHasChanged();
		}
	}

    
}
