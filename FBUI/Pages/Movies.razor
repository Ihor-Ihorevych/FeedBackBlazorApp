@page "/movies"
@inject IFBApiClient ApiClient
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IDialogService DialogService
@using FBUI.Components;
@using Microsoft.FluentUI.AspNetCore.Components;

<PageTitle>Movies - FB App</PageTitle>

<div class="py-8">
    <div class="flex justify-between items-end mb-8">
        <div>
            <h1 class="text-3xl font-light tracking-tight text-neutral-100">Movies</h1>
            <p class="text-neutral-500 mt-2 text-sm">Browse and discover</p>
        </div>
        <AuthorizeView Roles="Administrator">
            <Authorized>
                <FluentButton Appearance="Appearance.Outline"
                              OnClick="@(() => Navigation.NavigateTo("/movies/create"))"
                              Class="border-neutral-700 text-neutral-300">
                    Add Movie
                </FluentButton>
            </Authorized>
        </AuthorizeView>
    </div>

    <div class="mb-8 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <FluentTextField @bind-Value="_searchTerm"
                             @bind-Value:after="OnFilterValuesChanged"
                             Immediate="true"
                             Label="Search movies"
                             Placeholder="Search by title"
                             Style="width: 100%;">
                <FluentIcon Value="@(new Icons.Regular.Size20.Search())" Slot="start" />
            </FluentTextField>

            <FluentTextField @bind-Value="_genreFilter"
                             @bind-Value:after="OnFilterValuesChanged"
                             Immediate="true"
                             Label="Filter by genre"
                             Placeholder="e.g., Action, Drama, Adventure..."
                             Style="width: 100%;">
                <FluentIcon Value="@(new Icons.Regular.Size20.Filter())" Slot="start" />
            </FluentTextField>
        </div>

        @if (!string.IsNullOrEmpty(_searchTerm) || !string.IsNullOrEmpty(_genreFilter))
        {
            <div class="flex items-center gap-2">
                <span class="text-sm text-neutral-400">Active filters:</span>
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <FluentBadge Appearance="Appearance.Accent" OnDismissClick="ClearSearchTerm">
                        Search: @_searchTerm
                    </FluentBadge>
                }
                @if (!string.IsNullOrEmpty(_genreFilter))
                {
                    <FluentBadge Appearance="Appearance.Accent" OnDismissClick="ClearGenreFilter">
                        Genre: @_genreFilter
                    </FluentBadge>
                }
                <FluentButton Appearance="Appearance.Lightweight"
                              OnClick="ClearAllFilters"
                              Class="text-xs">
                    Clear all
                </FluentButton>
            </div>
        }
    </div>

    @if (_isLoading)
    {
        <div class="flex justify-center py-20">
            <FluentProgressRing />
        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        <div class="py-20 text-center">
            <p class="text-neutral-400 mb-4">Failed to load movies</p>
            <p class="text-sm text-neutral-500 mb-6">@_error</p>
            <FluentButton Appearance="Appearance.Outline"
                          OnClick="LoadMoviesAsync"
                          Class="border-neutral-700 text-neutral-300">
                Try Again
            </FluentButton>
        </div>
    }
    else if (_movies?.Items is null || !_movies.Items.Any())
    {
        <div class="py-20 text-center">
            <p class="text-neutral-400">No movies yet</p>
            <p class="text-sm text-neutral-500 mt-2">Be the first to add one.</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            @foreach (var movie in _movies.Items)
            {
                <MovieCard Movie="@movie" />
            }
        </div>
        @if (_movies.TotalPages > 1)
        {
            <div class="flex justify-center mt-12">
                <FluentPaginator State="@_paginationState"
                CurrentPageIndexChanged="OnPageIndexChangedAsync" />
            </div>
        }
    }
</div>

@code {
    private PaginatedListOfMovieDto? _movies;
    private bool _isLoading = true;
    private string? _error;

    private const int _pageSize = 12;
    private readonly PaginationState _paginationState = new()
    {
        ItemsPerPage = _pageSize
    };

    private string _searchTerm = string.Empty;
    private string _genreFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadMoviesAsync();
    }

    private async Task LoadMoviesAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var apiPageNumber = _paginationState.CurrentPageIndex + 1;

            _movies = await ApiClient.GetMoviesAsync(
                apiPageNumber,
                _paginationState.ItemsPerPage,
                _searchTerm,
                _genreFilter
            );

            if (_movies is { TotalCount: { } itemsTotalCount })
            {
                await _paginationState.SetTotalItemCountAsync(itemsTotalCount);
            }

            if (_movies.TotalPages > 0 &&
                _paginationState.CurrentPageIndex >= _movies.TotalPages)
            {
                var lastPageIndex = _movies.TotalPages - 1;
                await _paginationState.SetCurrentPageIndexAsync(lastPageIndex);
                var correctedPageNumber = lastPageIndex + 1;

                _movies = await ApiClient.GetMoviesAsync(
                    correctedPageNumber,
                    _paginationState.ItemsPerPage,
                    _searchTerm,
                    _genreFilter
                );
            }
        }
        catch (ApiException ex)
        {
            _error = $"API Error ({ex.StatusCode}): {ex.Message}";
            Console.WriteLine($"API Exception: {ex.StatusCode} - {ex.Message}");
            Console.WriteLine($"Response: {ex.Response}");
        }
        catch (HttpRequestException ex)
        {
            _error = $"Network Error: {ex.Message}";
            Console.WriteLine($"HTTP Exception: {ex.Message}");
        }
        catch (Exception ex)
        {
            _error = $"Error: {ex.Message}";
            Console.WriteLine($"Exception: {ex.GetType().Name} - {ex.Message}");
            Console.WriteLine($"Stack: {ex.StackTrace}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnPageIndexChangedAsync(int pageIndex)
    {
        await _paginationState.SetCurrentPageIndexAsync(pageIndex);
        await LoadMoviesAsync();
    }

    private async void OnFilterValuesChanged()
    {
        await Task.Delay(500);
        await InvokeAsync(async () =>
        {
            await _paginationState.SetCurrentPageIndexAsync(0);
            await LoadMoviesAsync();
        });
    }

    private async Task ClearSearchTerm()
    {
        _searchTerm = string.Empty;
        await _paginationState.SetCurrentPageIndexAsync(0);
        await LoadMoviesAsync();
    }

    private async Task ClearGenreFilter()
    {
        _genreFilter = string.Empty;
        await _paginationState.SetCurrentPageIndexAsync(0);
        await LoadMoviesAsync();
    }

    private async Task ClearAllFilters()
    {
        _searchTerm = string.Empty;
        _genreFilter = string.Empty;
        await _paginationState.SetCurrentPageIndexAsync(0);
        await LoadMoviesAsync();
    }
}
