@page "/movies"
@implements IDisposable
@inject IFBApiClient ApiClient
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IDialogService DialogService
@using FBUI.Components;
<PageTitle>Movies - FB App</PageTitle>

<div class="py-8">
    <div class="flex justify-between items-end mb-8">
        <div>
            <h1 class="text-3xl font-light tracking-tight text-neutral-100">Movies</h1>
            <p class="text-neutral-500 mt-2 text-sm">Browse and discover</p>
        </div>
        <AuthorizeView Roles="Administrator">
            <Authorized>
                <FluentButton Appearance="Appearance.Outline" OnClick="@(() => Navigation.NavigateTo("/movies/create"))" Class="border-neutral-700 text-neutral-300">
                    Add Movie
                </FluentButton>
            </Authorized>
        </AuthorizeView>
    </div>

    <div class="mb-8 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <FluentTextField @bind-Value="_searchTerm"
                             @bind-Value:after="OnSearchChanged"
                             Immediate="true"
                             Label="Search movies"
                             Placeholder="Search by title, director, or description..."
                             Style="width: 100%;">
                <FluentIcon Value="@(new Icons.Regular.Size20.Search())" Slot="start" />
            </FluentTextField>

            <FluentTextField @bind-Value="_genreFilter"
                             @bind-Value:after="OnGenreChanged"
                             Immediate="true"
                             Label="Filter by genre"
                             Placeholder="e.g., Action, Drama, Comedy..."
                             Style="width: 100%;">
                <FluentIcon Value="@(new Icons.Regular.Size20.Filter())" Slot="start" />
            </FluentTextField>
        </div>

        @if (!string.IsNullOrEmpty(_searchTerm) || !string.IsNullOrEmpty(_genreFilter))
        {
            <div class="flex items-center gap-2">
                <span class="text-sm text-neutral-400">Active filters:</span>
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <FluentBadge Appearance="Appearance.Accent" OnDismissClick="ClearSearchTerm">
                        Search: @_searchTerm
                    </FluentBadge>
                }
                @if (!string.IsNullOrEmpty(_genreFilter))
                {
                    <FluentBadge Appearance="Appearance.Accent" OnDismissClick="ClearGenreFilter">
                        Genre: @_genreFilter
                    </FluentBadge>
                }
                <FluentButton Appearance="Appearance.Lightweight" OnClick="ClearAllFilters" Class="text-xs">
                    Clear all
                </FluentButton>
            </div>
        }
    </div>

    @if (_isLoading)
    {
        <div class="flex justify-center py-20">
            <FluentProgressRing />
        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        <div class="py-20 text-center">
            <p class="text-neutral-400 mb-4">Failed to load movies</p>
            <p class="text-sm text-neutral-500 mb-6">@_error</p>
            <FluentButton Appearance="Appearance.Outline" OnClick="LoadMoviesAsync" Class="border-neutral-700 text-neutral-300">
                Try Again
            </FluentButton>
        </div>
    }
    else if (_movies?.Items is null || !_movies.Items.Any())
    {
        <div class="py-20 text-center">
            <p class="text-neutral-400">No movies yet</p>
            <p class="text-sm text-neutral-500 mt-2">Be the first to add one.</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            @foreach (var movie in _movies.Items)
            {
                <MovieCard Movie="@movie" />
            }
        </div>

        @if (_movies.TotalPages > 1)
        {
            <div class="flex justify-center mt-12">
                <FluentPaginator State="@_paginationState" CurrentPage="@(_currentPage - 1)"
                                 TotalItemCount="@_movies.TotalCount" ItemsPerPage="@_pageSize"
                                 OnPageChange="OnPageChangeAsync" />
            </div>
        }
    }
</div>

@code {
    private PaginatedListOfMovieDto? _movies;
    private bool _isLoading = true;
    private string? _error;
    private int _currentPage = 1;
    private const int _pageSize = 12;
    private readonly PaginationState _paginationState = new() { ItemsPerPage = _pageSize };

    private string _searchTerm = string.Empty;
    private string _genreFilter = string.Empty;
    private System.Threading.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadMoviesAsync();
    }

    private async Task LoadMoviesAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            _movies = await ApiClient.GetMoviesAsync(_currentPage, _pageSize, _searchTerm, _genreFilter);
        }
        catch (ApiException ex)
        {
            _error = $"API Error ({ex.StatusCode}): {ex.Message}";
            Console.WriteLine($"API Exception: {ex.StatusCode} - {ex.Message}");
            Console.WriteLine($"Response: {ex.Response}");
        }
        catch (HttpRequestException ex)
        {
            _error = $"Network Error: {ex.Message}";
            Console.WriteLine($"HTTP Exception: {ex.Message}");
        }
        catch (Exception ex)
        {
            _error = $"Error: {ex.Message}";
            Console.WriteLine($"Exception: {ex.GetType().Name} - {ex.Message}");
            Console.WriteLine($"Stack: {ex.StackTrace}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnPageChangeAsync(int pageNumber)
    {
        _currentPage = pageNumber + 1;
        await LoadMoviesAsync();
    }

    private void OnSearchChanged()
    {
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(async () =>
            {
                _currentPage = 1;
                await LoadMoviesAsync();
            });
        }, null, 500, System.Threading.Timeout.Infinite);
    }

    private void OnGenreChanged()
    {
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(async () =>
            {
                _currentPage = 1;
                await LoadMoviesAsync();
            });
        }, null, 500, System.Threading.Timeout.Infinite);
    }

    private async Task ClearSearchTerm()
    {
        _searchTerm = string.Empty;
        _currentPage = 1;
        await LoadMoviesAsync();
    }

    private async Task ClearGenreFilter()
    {
        _genreFilter = string.Empty;
        _currentPage = 1;
        await LoadMoviesAsync();
    }

    private async Task ClearAllFilters()
    {
        _searchTerm = string.Empty;
        _genreFilter = string.Empty;
        _currentPage = 1;
        await LoadMoviesAsync();
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
