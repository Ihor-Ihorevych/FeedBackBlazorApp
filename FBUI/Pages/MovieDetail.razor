@page "/movies/{Id:guid}"
@using FBUI.Extensions
@using FBUI.Components;
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IDialogService DialogService
@inject IMovieService MovieService
@inject ICommentService CommentService
@inject ICommentModerationService CommentModerationService

<PageTitle>@(_movie?.Title ?? "Movie") - FB App</PageTitle>

<div class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => Navigation.NavigateTo("/movies"))">
        <FluentIcon Value="@(new Icons.Regular.Size20.ArrowLeft())" Slot="start" />
        Back to Movies
    </FluentButton>

    @if (_isLoading)
    {
        <div class="flex justify-center py-16">
            <FluentProgressRing />
        </div>
    }
    else if (_movie is null)
    {
        <FluentCard Class="p-8 text-center">
            <FluentIcon Value="@(new Icons.Regular.Size32.Warning())" Color="Color.Warning" Class="mx-auto mb-4" />
            <h3 class="text-xl font-semibold text-neutral-100">Movie not found</h3>
            <p class="text-sm text-neutral-400 mt-2">The movie you're looking for doesn't exist.</p>
        </FluentCard>
    }
    else
    {
        <MovieInfoCard Movie="@_movie" OnEdit="EditMovie" OnDelete="DeleteMovieAsync" />

        <CommentsSection Comments="@_comments"
                         ShowCommentForm="@_showCommentForm"
                         ShowCommentFormChanged="@((value) => _showCommentForm = value)"
                         IsSubmittingComment="@_isSubmittingComment"
                         ModeratingComments="@_moderatingComments"
                         OnCommentSubmit="SubmitCommentAsync"
                         OnCommentApprove="ApproveCommentAsync"
                         OnCommentReject="RejectCommentAsync" />
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MovieDetailDto? _movie;
    private List<CommentDetailDto>? _comments;
    private bool _isLoading = true;
    private bool _showCommentForm;
    private bool _isSubmittingComment;
    private readonly HashSet<Guid> _moderatingComments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        try
        {
            var result = await MovieService.GetMovieByIdAsync(Id);

            if (result.IsSuccess)
            {
                _movie = result.Value;
                await LoadCommentsAsync();
            }
            else if (result.Status == Ardalis.Result.ResultStatus.NotFound)
            {
                _movie = null;
            }
            else
            {
                ToastService.ShowError(string.Join(", ", result.Errors));
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadCommentsAsync()
    {
        var result = await CommentService.GetCommentsByMovieAsync(Id);
        _comments = result.IsSuccess ? result.Value.ToList() : [];
    }

    private void EditMovie()
    {
        Navigation.NavigateTo($"/movies/{Id}/edit");
    }

    private async Task DeleteMovieAsync()
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            "Are you sure you want to delete this movie?",
            "Yes, Delete",
            "Cancel",
            "Confirm Delete");

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var deleteResult = await MovieService.DeleteMovieAsync(Id);

            if (deleteResult.IsSuccess)
            {
                ToastService.ShowSuccess("Movie deleted successfully!");
                Navigation.NavigateTo("/movies");
            }
            else
            {
                ToastService.ShowError(string.Join(", ", deleteResult.Errors));
            }
        }
    }

    private async Task SubmitCommentAsync(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
        {
            ToastService.ShowWarning("Please enter a comment.");
            return;
        }

        _isSubmittingComment = true;

        try
        {
            var result = await CommentService.CreateCommentAsync(Id, content);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Comment submitted! It will appear after moderation.");
                _showCommentForm = false;
                await LoadDataAsync();
            }
            else
            {
                ToastService.ShowError(string.Join(", ", result.Errors));
            }
        }
        finally
        {
            _isSubmittingComment = false;
            StateHasChanged();
        }
    }

    private async Task ApproveCommentAsync(Guid commentId)
    {
        if (!_moderatingComments.Add(commentId))
        {
            return;
        }

        try
        {
            var result = await CommentModerationService.ApproveCommentAsync(Id, commentId);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Comment approved.");
                await LoadCommentsAsync();
            }
            else
            {
                ToastService.ShowError($"Failed to approve comment: {string.Join(',', result.Errors)}");
            }
        }
        finally
        {
            _moderatingComments.Remove(commentId);
        }
    }

    private async Task RejectCommentAsync(Guid commentId)
    {
        if (!_moderatingComments.Add(commentId))
        {
            return;
        }

        try
        {
            var result = await CommentModerationService.RejectCommentAsync(Id, commentId);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Comment rejected.");
                await LoadCommentsAsync();
            }
            else
            {
                ToastService.ShowError($"Failed to reject comment: {string.Join(',', result.Errors)}");
            }
        }
        finally
        {
            _moderatingComments.Remove(commentId);
        }
    }
}
