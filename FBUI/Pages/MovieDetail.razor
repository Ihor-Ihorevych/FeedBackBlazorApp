@page "/movies/{Id:guid}"
@inject IFBApiClient ApiClient
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IDialogService DialogService

<PageTitle>@(_movie?.Title ?? "Movie") - FB App</PageTitle>

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <FluentButton Appearance="Appearance.Stealth"
                  Class="shadow-md hover:shadow-xl hover:bg-neutral-100 dark:hover:bg-neutral-800 focus:outline-none focus:ring-4 focus:ring-neutral-500/50 transition-all duration-300 rounded-xl px-6 py-3 font-medium"
                  OnClick="@(() => Navigation.NavigateTo("/movies"))">
        <FluentIcon Value="@(new Icons.Regular.Size20.ArrowLeft())" Slot="start" />
        Back to Movies
    </FluentButton>

    @if (_isLoading)
    {
        <div class="flex flex-col justify-center items-center py-20 space-y-4 bg-gradient-to-br from-neutral-50/80 to-neutral-100/80 dark:from-neutral-900/50 dark:to-neutral-800/50 rounded-3xl shadow-2xl backdrop-blur-md border border-neutral-200/50 dark:border-neutral-700/50">
            <FluentProgressRing Class="w-16 h-16" />
            <p class="text-lg text-neutral-600 dark:text-neutral-400 font-medium">Loading movie details...</p>
        </div>
    }
    else if (_movie is null)
    {
        <FluentCard Class="p-12 lg:p-16 text-center shadow-2xl rounded-3xl bg-gradient-to-br from-red-50 to-orange-50 dark:from-red-900/30 dark:to-orange-900/30 border border-red-200/50 dark:border-red-800/50">
            <FluentIcon Value="@(new Icons.Regular.Size48.Warning())" Color="Color.Warning" Class="mx-auto mb-6 drop-shadow-lg" />
            <h3 class="text-2xl lg:text-3xl font-black text-neutral-800 dark:text-neutral-100 mb-4 leading-tight">Movie not found</h3>
            <p class="text-xl text-neutral-600 dark:text-neutral-400 font-medium leading-relaxed max-w-md mx-auto">The movie you're looking for doesn't exist or has been removed.</p>
        </FluentCard>
    }
    else
    {
        <FluentCard Class="overflow-hidden shadow-2xl rounded-3xl border border-neutral-200/50 dark:border-neutral-700/50 backdrop-blur-sm">
            <div class="relative h-64 md:h-80 lg:h-96 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 overflow-hidden">
                <div class="absolute inset-0 bg-black/25 backdrop-blur-sm" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent" />
                <div class="relative z-10 flex items-center justify-center h-full px-4">
                    <FluentIcon Value="@(new Icons.Regular.Size48.Video())" Color="Color.Accent" />
                </div>
            </div>
            <div class="p-8 lg:p-12 xl:p-16 space-y-6">
                <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-6">
                    <div class="flex-1">
                        <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-neutral-900 dark:text-white drop-shadow-2xl leading-tight">@_movie.Title</h1>
                        <div class="flex flex-wrap items-center gap-3 mt-4">
                            @if (!string.IsNullOrEmpty(_movie.Director))
                            {
                                <div class="px-4 py-2 bg-neutral-100/80 dark:bg-neutral-800/80 rounded-2xl text-sm font-semibold flex items-center gap-2 shadow-md backdrop-blur-sm border border-neutral-200/50 dark:border-neutral-700/50">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Person())" Color="Color.Neutral" />
                                    @_movie.Director
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(_movie.Genre))
                            {
                                <FluentBadge Appearance="Appearance.Accent" Class="shadow-lg px-4 py-2 font-semibold text-sm rounded-2xl backdrop-blur-sm">@_movie.Genre</FluentBadge>
                            }
                            @if (_movie.ReleaseYear.HasValue)
                            {
                                <FluentBadge Appearance="Appearance.Neutral" Class="shadow-lg px-4 py-2 font-semibold text-sm rounded-2xl backdrop-blur-sm">@_movie.ReleaseYear.Value</FluentBadge>
                            }
                        </div>
                    </div>
                    @if (_movie.Rating.HasValue)
                    {
                        <div class="flex-shrink-0 flex items-center gap-3 bg-gradient-to-r from-yellow-400 via-amber-400 to-orange-500 px-8 py-4 lg:py-5 rounded-3xl shadow-2xl backdrop-blur-md border border-yellow-300/50 dark:border-yellow-400/50">
                            <FluentIcon Value="@(new Icons.Filled.Size28.Star())" Color="Color.Success" />
                            <span class="text-3xl lg:text-4xl font-black text-white drop-shadow-lg">
                                @_movie.Rating.Value.ToString("F1")
                            </span>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(_movie.Description))
                {
                    <div class="pt-8 border-t border-neutral-200/50 dark:border-neutral-700/50">
                        <h3 class="text-2xl font-bold text-neutral-800 dark:text-neutral-200 mb-6 flex items-center gap-3">
                            <FluentIcon Value="@(new Icons.Regular.Size24.DocumentText())" />
                            Description
                        </h3>
                        <p class="text-lg lg:text-xl text-neutral-700 dark:text-neutral-300 leading-relaxed lg:leading-9">@_movie.Description</p>
                    </div>
                }

                <AuthorizeView Roles="Administrator">
                    <Authorized>
                        <div class="flex flex-wrap gap-4 pt-8 border-t border-neutral-200/50 dark:border-neutral-700/50">
                            <FluentButton Appearance="Appearance.Outline"
                                          Class="shadow-xl hover:shadow-2xl focus:ring-4 focus:ring-blue-500/50 transition-all duration-300 rounded-2xl px-8 py-4 font-semibold flex-1 lg:flex-none"
                                          OnClick="EditMovie">
                                <FluentIcon Value="@(new Icons.Regular.Size20.Edit())" Slot="start" />
                                Edit Movie
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Outline"
                                          Class="shadow-xl hover:shadow-2xl focus:ring-4 focus:ring-red-500/50 transition-all duration-300 rounded-2xl px-8 py-4 font-semibold flex-1 lg:flex-none"
                                          OnClick="DeleteMovieAsync"
                                          Color="Color.Error">
                                <FluentIcon Value="@(new Icons.Regular.Size20.Delete())" Slot="start" />
                                Delete Movie
                            </FluentButton>
                        </div>
                    </Authorized>
                </AuthorizeView>
            </div>
        </FluentCard>

        <FluentCard Class="p-8 lg:p-12 shadow-2xl rounded-3xl border border-neutral-200/50 dark:border-neutral-700/50 backdrop-blur-sm">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-8 lg:mb-12 gap-4">
                <h2 class="text-2xl lg:text-3xl font-black bg-gradient-to-r from-neutral-900 via-neutral-800 to-neutral-700 dark:from-neutral-50 dark:via-neutral-200 dark:to-neutral-100 bg-clip-text text-transparent flex items-center gap-3">
                    <FluentIcon Value="@(new Icons.Regular.Size24.Comment())" />
                    Comments (@(_comments?.Count ?? 0))
                </h2>
                <AuthorizeView>
                    <Authorized>
                        <FluentButton Appearance="Appearance.Accent"
                                      Class="shadow-xl hover:shadow-2xl focus:ring-4 focus:ring-accent-500/50 transition-all duration-300 rounded-2xl px-8 py-4 font-semibold lg:ml-auto"
                                      OnClick="@(() => _showCommentForm = !_showCommentForm)">
                            <FluentIcon Value="@(new Icons.Regular.Size20.Add())" Slot="start" />
                            Add Comment
                        </FluentButton>
                    </Authorized>
                </AuthorizeView>
            </div>

            <AuthorizeView>
                <Authorized>
                    @if (_showCommentForm)
                    {
                        <FluentCard Class="p-8 mb-12 shadow-2xl rounded-3xl bg-gradient-to-br from-emerald-50/80 via-blue-50/80 to-indigo-50/80 dark:from-emerald-900/40 dark:via-blue-900/40 dark:to-indigo-900/40 border border-emerald-200/50 dark:border-emerald-800/50 backdrop-blur-md">
                            <div class="space-y-6">
                                <FluentTextArea @bind-Value="_newComment.Content"
                                                Label="Share your thoughts on this movie..."
                                                Placeholder="Write a detailed review, spoiler-free or with warnings..."
                                                Rows="4"
                                                Class="shadow-xl focus:shadow-2xl focus:ring-4 ring-blue-500/50 transition-all duration-300 resize-none border-0 rounded-2xl" />

                                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                                    <FluentButton Appearance="Appearance.Accent"
                                                  OnClick="SubmitCommentAsync"
                                                  Loading="@_isSubmittingComment"
                                                  Class="shadow-xl hover:shadow-2xl focus:ring-4 focus:ring-accent-500/50 transition-all duration-300 rounded-2xl px-10 py-4 font-semibold flex-1 sm:flex-none">
                                        <FluentIcon Value="@(new Icons.Regular.Size20.Send())" Slot="end" />
                                        Submit Comment
                                    </FluentButton>
                                    <FluentButton Appearance="Appearance.Stealth"
                                                  OnClick="@(() => _showCommentForm = false)"
                                                  Class="shadow-lg hover:shadow-xl focus:ring-4 focus:ring-neutral-500/50 transition-all duration-300 rounded-2xl px-10 py-4 font-semibold flex-1 sm:flex-none">
                                        Cancel
                                    </FluentButton>
                                </div>
                            </div>
                        </FluentCard>
                    }
                </Authorized>
            </AuthorizeView>

            @if (_comments is null || !_comments.Any())
            {
                <div class="flex flex-col items-center justify-center py-20 text-center space-y-4 bg-neutral-50/70 dark:bg-neutral-900/50 rounded-3xl shadow-inner border border-neutral-200/50 dark:border-neutral-700/50">
                    <FluentIcon Value="@(new Icons.Regular.Size48.Chat())" Color="Color.Neutral" Class="drop-shadow-lg" />
                    <h3 class="text-2xl font-bold text-neutral-600 dark:text-neutral-400">No comments yet</h3>
                    <p class="text-lg text-neutral-500 dark:text-neutral-500 max-w-md leading-relaxed">Be the first to share your thoughts! Your comment will appear after moderation.</p>
                </div>
            }
            else
            {
                <div class="space-y-6">
                    @foreach (var comment in _comments)
                    {
                        <FluentCard Class="p-8 shadow-xl hover:shadow-2xl hover:-translate-y-2 focus-within:shadow-2xl transition-all duration-500 rounded-3xl border-0 bg-white/80 dark:bg-neutral-800/80 backdrop-blur-xl hover:bg-white/90 dark:hover:bg-neutral-800/90">
                            <div class="flex justify-between items-start mb-6 gap-4">
                                <div class="flex items-start gap-4 flex-1 min-w-0">
                                    <FluentPersona Name="@(string.IsNullOrWhiteSpace(comment.UserName) ? "Anonymous" : comment.UserName)" Size="48" Class="shadow-xl flex-shrink-0 drop-shadow-lg" />
                                    <div class="min-w-0 flex-1">
                                        <span class="block font-bold text-xl text-neutral-900 dark:text-neutral-100 truncate">
                                            @(string.IsNullOrWhiteSpace(comment.UserName) ? "Anonymous" : comment.UserName)
                                        </span>
                                        <span class="text-sm text-neutral-500 font-medium">
                                            @comment.Created.ToString("MMM dd, yyyy 'at' HH:mm")
                                        </span>
                                    </div>
                                </div>
                                <FluentBadge Appearance="@GetStatusAppearance(comment.Status)" Class="shadow-lg px-4 py-2 font-semibold text-sm rounded-xl flex-shrink-0 whitespace-nowrap">
                                    @comment.Status
                                </FluentBadge>
                            </div>
                            <div class="pl-20 md:pl-24 text-neutral-700 dark:text-neutral-300 text-base lg:text-lg leading-relaxed lg:leading-8">
                                @comment.Text
                            </div>
                        </FluentCard>
                    }
                </div>
            }
        </FluentCard>
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MovieDetailDto? _movie;
    private List<CommentDetailDto>? _comments;
    private bool _isLoading = true;
    private bool _showCommentForm;
    private bool _isSubmittingComment;
    private readonly NewCommentModel _newComment = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        try
        {
            _movie = await ApiClient.GetMovieByIdAsync(Id);
            
            try
            {
                _comments = (await ApiClient.GetCommentsByMovieAsync(Id, null))?.ToList();
            }
            catch
            {
                _comments = new List<CommentDetailDto>();
            }
        }
        catch (ApiException ex) when (ex.StatusCode == 404)
        {
            _movie = null;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load movie: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void EditMovie()
    {
        Navigation.NavigateTo($"/movies/{Id}/edit");
    }

    private async Task DeleteMovieAsync()
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            "Are you sure you want to delete this movie?",
            "Yes, Delete",
            "Cancel",
            "Confirm Delete");

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            try
            {
                await ApiClient.DeleteMovieAsync(Id);
                ToastService.ShowSuccess("Movie deleted successfully!");
                Navigation.NavigateTo("/movies");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to delete movie: {ex.Message}");
            }
        }
    }

    private async Task SubmitCommentAsync()
    {
        if (string.IsNullOrWhiteSpace(_newComment.Content))
        {
            ToastService.ShowWarning("Please enter a comment.");
            return;
        }

        _isSubmittingComment = true;

        try
        {
            var command = new CreateCommentCommand
            {
                MovieId = Id,
                Text = _newComment.Content,
            };

            await ApiClient.CreateCommentAsync(command);
            ToastService.ShowSuccess("Comment submitted! It will appear after moderation.");
            
            _newComment.Content = string.Empty;
            _showCommentForm = false;
            
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to submit comment: {ex.Message}");
        }
        finally
        {
            _isSubmittingComment = false;
        }
    }

    private static Appearance GetStatusAppearance(CommentStatus status) => status switch
    {
        CommentStatus.Approved => Appearance.Accent,
        CommentStatus.Pending => Appearance.Neutral,
        CommentStatus.Rejected => Appearance.Lightweight,
        _ => Appearance.Neutral
    };

    private class NewCommentModel
    {
        public string Content { get; set; } = string.Empty;
    }
}
