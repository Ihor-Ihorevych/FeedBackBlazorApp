@page "/movies/{Id:guid}"
@using FBUI.Extensions
@using FBUI.Components;
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IDialogService DialogService
@inject IFBApiClient ApiClient
@inject ICommentModerationService CommentModerationService

<PageTitle>@(_movie?.Title ?? "Movie") - FB App</PageTitle>

<div class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => Navigation.NavigateTo("/movies"))">
        <FluentIcon Value="@(new Icons.Regular.Size20.ArrowLeft())" Slot="start" />
        Back to Movies
    </FluentButton>

    @if (_isLoading)
    {
        <div class="flex justify-center py-16">
            <FluentProgressRing />
        </div>
    }
    else if (_movie is null)
    {
        <FluentCard Class="p-8 text-center">
            <FluentIcon Value="@(new Icons.Regular.Size32.Warning())" Color="Color.Warning" Class="mx-auto mb-4" />
            <h3 class="text-xl font-semibold text-neutral-100">Movie not found</h3>
            <p class="text-sm text-neutral-400 mt-2">The movie you're looking for doesn't exist.</p>
        </FluentCard>
    }
    else
    {
        <MovieInfoCard Movie="@_movie" OnEdit="EditMovie" OnDelete="DeleteMovieAsync" />

        <CommentsSection Comments="@_comments"
                         ShowCommentForm="@_showCommentForm"
                         ShowCommentFormChanged="@((value) => _showCommentForm = value)"
                         IsSubmittingComment="@_isSubmittingComment"
                         ModeratingComments="@_moderatingComments"
                         OnCommentSubmit="SubmitCommentAsync"
                         OnCommentApprove="ApproveCommentAsync"
                         OnCommentReject="RejectCommentAsync" />
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MovieDetailDto? _movie;
    private List<CommentDetailDto>? _comments;
    private bool _isLoading = true;
    private bool _showCommentForm;
    private bool _isSubmittingComment;
    private readonly HashSet<Guid> _moderatingComments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        try
        {
            _movie = await ApiClient.GetMovieByIdAsync(Id);
            await LoadCommentsAsync();
        }
        catch (ApiException ex) when (ex.StatusCode == 404)
        {
            _movie = null;
        }
        catch (ApiException<HttpValidationProblemDetails> ex)
        {
            ToastService.ShowError($"Validation error: {ex.GetValidationErrors()}");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load movie: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadCommentsAsync()
    {
        try
        {
            _comments = (await ApiClient.GetCommentsByMovieAsync(Id, null))?.ToList();
        }
        catch
        {
            _comments = [];
        }
    }

    private void EditMovie()
    {
        Navigation.NavigateTo($"/movies/{Id}/edit");
    }

    private async Task DeleteMovieAsync()
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            "Are you sure you want to delete this movie?",
            "Yes, Delete",
            "Cancel",
            "Confirm Delete");

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            try
            {
                await ApiClient.DeleteMovieAsync(Id);
                ToastService.ShowSuccess("Movie deleted successfully!");
                Navigation.NavigateTo("/movies");
            }
            catch (ApiException<HttpValidationProblemDetails> ex)
            {
                ToastService.ShowError($"Validation error: {ex.GetValidationErrors()}");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to delete movie: {ex.Message}");
            }
        }
    }

    private async Task SubmitCommentAsync(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
        {
            ToastService.ShowWarning("Please enter a comment.");
            return;
        }

        _isSubmittingComment = true;

        try
        {
            var command = new CreateCommentCommand
            {
                MovieId = Id,
                Text = content,
            };

            await ApiClient.CreateCommentAsync(command);
            ToastService.ShowSuccess("Comment submitted! It will appear after moderation.");

            _showCommentForm = false;
            await LoadDataAsync();
        }
        catch (ApiException<HttpValidationProblemDetails> ex)
        {
            ToastService.ShowError($"Validation error: {ex.GetValidationErrors()}");
        }
        catch (ApiException<ProblemDetails> ex)
        {
            ToastService.ShowError(ex.GetProblemDetails());
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to submit comment: {ex.Message}");
        }
        finally
        {
            _isSubmittingComment = false;
            StateHasChanged();
        }
    }

    private async Task ApproveCommentAsync(Guid commentId)
    {
        if (!_moderatingComments.Add(commentId))
        {
            return;
        }

        try
        {
            var result = await CommentModerationService.ApproveCommentAsync(Id, commentId);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Comment approved.");
                await LoadCommentsAsync();
            }
            else
            {
                ToastService.ShowError($"Failed to approve comment: {string.Join(',', result.Errors)}");
            }
        }
        finally
        {
            _moderatingComments.Remove(commentId);
        }
    }

    private async Task RejectCommentAsync(Guid commentId)
    {
        if (!_moderatingComments.Add(commentId))
        {
            return;
        }

        try
        {
            var result = await CommentModerationService.RejectCommentAsync(Id, commentId);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Comment rejected.");
                await LoadCommentsAsync();
            }
            else
            {
                ToastService.ShowError($"Failed to reject comment: {string.Join(',', result.Errors)}");
            }
        }
        finally
        {
            _moderatingComments.Remove(commentId);
        }
    }
}
